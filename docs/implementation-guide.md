# Prototype Collaboration Tool — Implementation Guide

Technical documentation for developers working on the application codebase.

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| Framework | Next.js 15 (App Router) |
| UI | React 19, MUI 6, Emotion 11 |
| State | Zustand 5 (3 stores) |
| Bundling | esbuild 0.24 (server-side JSX → ESM) |
| AST | Babel (parser, traverse, generator) |
| Drag & Drop | dnd-kit (core, sortable, utilities) |
| File Watch | chokidar 4 |
| IDs | nanoid 5 |
| Language | TypeScript 5 |

---

## Project Structure

```
src/
├── app/
│   ├── (shell)/                    # App shell layout (toolbar, sidebar, panels)
│   │   ├── layout.tsx              # Shell layout with ThemeProvider + InitColorSchemeScript
│   │   ├── page.tsx                # Gallery (home) — prototype list, search, create, delete
│   │   └── prototype/[id]/
│   │       └── page.tsx            # Workspace — toolbar + sidebar + preview + inspector
│   ├── (share)/
│   │   └── share/[token]/
│   │       └── page.tsx            # Public read-only preview (resolved via share token)
│   ├── api/
│   │   ├── prototypes/
│   │   │   ├── route.ts            # GET (list) + POST (create)
│   │   │   └── [id]/route.ts       # DELETE
│   │   ├── preview/[id]/
│   │   │   ├── bundle/route.ts     # GET — esbuild transpile JSX → ESM
│   │   │   ├── screens/route.ts    # GET + POST + PATCH
│   │   │   ├── tree/route.ts       # GET — Babel AST → component tree
│   │   │   ├── copy/route.ts       # GET + PATCH — text entries + copy overlay
│   │   │   ├── status/route.ts     # GET + PATCH
│   │   │   └── share/route.ts      # GET + POST — share token management
│   │   ├── share/[token]/route.ts  # GET — resolve token → prototype ID
│   │   └── watch/route.ts          # GET — SSE hot reload stream
│   └── preview/[id]/
│       └── route.ts                # GET — standalone iframe HTML (not wrapped by layout)
├── components/
│   ├── Toolbar.tsx                 # App bar with all toolbar controls
│   ├── ScreenSidebar.tsx           # Drag-sortable screen list + create dialog
│   ├── PreviewFrame.tsx            # Iframe wrapper, postMessage bridge, SSE listener
│   ├── InspectorPanel.tsx          # Right panel with Copy/Components tabs
│   ├── ComponentTree.tsx           # Recursive MUI component tree view
│   ├── PropInspector.tsx           # Selected component props table
│   ├── CopyTab.tsx                 # Text editing UI (grouped entries, search, export/import)
│   ├── BreakpointSwitcher.tsx      # Responsive width selector
│   ├── StatusBadge.tsx             # Clickable status chip with dropdown
│   ├── ShareButton.tsx             # Share URL popover
│   └── ErrorDisplay.tsx            # Error state with retry
├── stores/
│   ├── inspector.ts                # Panel, tree, selection, screens, breakpoint state
│   ├── theme.ts                    # Theme mode (wraps MUI useColorScheme)
│   └── copy.ts                     # Text entries, conflicts, search, edit state
├── lib/
│   ├── theme.ts                    # MUI theme creation (cssVariables, colorSchemes)
│   ├── bundler.ts                  # esbuild bundling logic
│   ├── extractTextEntries.ts       # Babel AST → text entry extraction
│   └── injectInspectorIds.ts       # Babel transform: adds data-inspector-id to MUI components
└── public/
    └── preview-bootstrap.js        # Iframe bootstrap: React root, theme, text overrides
prototypes/
└── {id}/
    ├── metadata.json               # Name, status, createdAt, shareToken, screens config
    ├── index.jsx                    # Main screen (always present)
    ├── screen-{slug}.jsx           # Additional screens
    └── copy-overlay.json           # Text edits (generated by Copy tab)
```

---

## Architecture Overview

### Iframe Isolation

Prototypes render inside a sandboxed iframe (`sandbox="allow-scripts allow-same-origin"`). This prevents prototype CSS/JS from leaking into the app shell.

**Rendering pipeline:**

1. `/preview/[id]?screen={screenId}` returns standalone HTML with an import map pointing to esm.sh CDN
2. The HTML loads `preview-bootstrap.js` as a module script
3. Bootstrap creates an Emotion cache scoped to the iframe's `<head>`, sets up MUI theme, and dynamically imports the bundle
4. `/api/preview/[id]/bundle?screen={screenId}` runs the source through a Babel pre-pass (injects `data-inspector-id` attributes) then esbuild (JSX → ESM, externals via import map)
5. Bootstrap renders the default export with `React.createElement()` inside ThemeProvider + CacheProvider + ErrorBoundary

**Why this matters:**

- MUI dependencies are resolved via esm.sh CDN import map → single React instance (no hook errors)
- Emotion cache targets iframe `document.head` → styles render in iframe, not parent
- `data-inspector-id` attributes enable component selection/hover without runtime introspection

### postMessage Protocol

Communication between the app shell and the iframe:

**Shell → Iframe:**

| Message | Purpose |
|---------|---------|
| `SET_THEME` | Sync theme mode (light/dark/system) |
| `RELOAD` | Re-import bundle (with cache buster) |
| `SET_TEXT_OVERRIDES` | Apply live text edits from Copy tab |
| `HIGHLIGHT_TEXT` | Highlight a text element when Copy entry is focused |

**Iframe → Shell:**

| Message | Purpose |
|---------|---------|
| `RENDER_ERROR` | Report import/render failure |
| `COMPONENT_HOVER` | Component hover (inspector tree highlights) |
| `COMPONENT_SELECT` | Component click (inspector tree selects + scrolls) |
| `TEXT_CLICK` | Text element click (Copy tab scrolls to entry) |

### Hot Reload (SSE)

1. `chokidar` watches the `prototypes/` directory
2. `/api/watch` streams file change events via Server-Sent Events
3. `PreviewFrame` subscribes with `EventSource`, filters for relevant changes (excludes `metadata.json`, `copy-overlay.json`)
4. On match → sends `RELOAD` postMessage to iframe → bootstrap re-imports bundle with `?t={timestamp}` cache buster
5. After reload → PreviewFrame re-fetches component tree from `/api/preview/[id]/tree`

---

## State Management

Three Zustand stores, no persistence (MUI handles theme persistence via localStorage).

### Inspector Store (`src/stores/inspector.ts`)

```typescript
// Key state
panelOpen: boolean              // Inspector panel visibility
activeTab: 'copy' | 'components'
selectedComponentId: string | null
hoveredComponentId: string | null
componentTree: ComponentNode[]
previewWidth: number | 'auto'   // Breakpoint selector
sidebarOpen: boolean            // Screen sidebar visibility
activeScreenId: string          // 'index' | slug
screens: Screen[]               // { id, name, file }[]
```

### Theme Store (`src/stores/theme.ts`)

Thin wrapper around MUI's `useColorScheme()` hook. Provides `mode` and `cycleMode()` (light → dark → system → light).

### Copy Store (`src/stores/copy.ts`)

```typescript
entries: CopyEntryWithHistory[]   // Text entries with edit history
conflicts: ConflictEntry[]        // Unresolved source/edit conflicts
summary: { total, modified }
searchQuery: string
collapsedGroups: Set<string>
highlightedKey: string | null     // Entry highlighted from preview click
```

---

## API Reference

All routes set `export const dynamic = 'force-dynamic'`.

### Prototypes

| Method | Route | Body | Response |
|--------|-------|------|----------|
| GET | `/api/prototypes` | — | `[{ id, name, status, createdAt, hasShareToken }]` |
| POST | `/api/prototypes` | `{ name }` | `{ id, name }` (201) |
| DELETE | `/api/prototypes/[id]` | — | `{ ok: true }` |

### Preview & Bundling

| Method | Route | Params | Response |
|--------|-------|--------|----------|
| GET | `/preview/[id]` | `?screen=` | Standalone HTML (iframe source) |
| GET | `/api/preview/[id]/bundle` | `?screen=` | JavaScript (ESM bundle) |

### Screens

| Method | Route | Body | Response |
|--------|-------|------|----------|
| GET | `/api/preview/[id]/screens` | — | `[{ id, name, file }]` |
| POST | `/api/preview/[id]/screens` | `{ name }` | `{ id, name, file }` (201), 409 if exists |
| PATCH | `/api/preview/[id]/screens` | `{ order?, customNames? }` | `{ ok: true }` |

### Component Tree

| Method | Route | Params | Response |
|--------|-------|--------|----------|
| GET | `/api/preview/[id]/tree` | `?screen=` | `ComponentNode[]` |

### Copy / Text Editing

| Method | Route | Body | Response |
|--------|-------|------|----------|
| GET | `/api/preview/[id]/copy` | `?screen=` | `{ entries, conflicts, summary, editsMap }` |
| PATCH | `/api/preview/[id]/copy` | `{ key, value, sourceValue, screen? }` | `{ ok: true }` |

### Status

| Method | Route | Body | Response |
|--------|-------|------|----------|
| GET | `/api/preview/[id]/status` | — | `{ status }` |
| PATCH | `/api/preview/[id]/status` | `{ status }` | `{ ok: true }` |

### Sharing

| Method | Route | Body | Response |
|--------|-------|------|----------|
| GET | `/api/preview/[id]/share` | — | `{ shareToken }` or `{ shareToken: null }` |
| POST | `/api/preview/[id]/share` | — | `{ shareToken }` (idempotent) |
| GET | `/api/share/[token]` | — | `{ prototypeId, name, status }` |

### File Watching

| Method | Route | Response |
|--------|-------|----------|
| GET | `/api/watch` | SSE stream: `{ file: string }` events |

---

## Prototype File Conventions

### Directory layout

```
prototypes/{id}/
├── metadata.json
├── index.jsx
├── screen-{slug}.jsx    (0 or more)
└── copy-overlay.json    (auto-generated)
```

### metadata.json schema

```json
{
  "name": "My Prototype",
  "createdAt": "2026-02-27T00:00:00Z",
  "status": "draft | review | approved",
  "shareToken": "ky40WCJ5gzMK",
  "screens": {
    "order": ["index", "login", "dashboard"],
    "customNames": { "index": "Home", "login": "Login Page" }
  }
}
```

### Screen file naming

- `index.jsx` → screen id `index`, always present
- `screen-{slug}.jsx` → screen id `{slug}`, slug derived from user-entered name

### JSX requirements

- Must have a default export (component function)
- Use bare MUI imports: `import { Box, Typography } from '@mui/material'`
- The bundler handles JSX transformation — no build config needed in prototype files

### Inspector ID injection

During bundling, a Babel transform (`injectInspectorIds.ts`) adds `data-inspector-id="{ComponentName}_{line}_{col}"` to every MUI component. This enables click-to-select and hover highlighting in the preview without runtime introspection.

### Text entry key format

`{ComponentName}_{line}_{col}_{propName}` — e.g., `Typography_5_4_children`

### copy-overlay.json schema

```json
{
  "version": 1,
  "entries": {
    "Typography_5_4_children": {
      "editedValue": "Updated heading",
      "editedAt": "2026-02-27T10:00:00Z",
      "sourceValueAtEdit": "Original heading",
      "edits": [
        { "value": "First edit", "timestamp": "2026-02-27T09:00:00Z" },
        { "value": "Updated heading", "timestamp": "2026-02-27T10:00:00Z" }
      ]
    }
  }
}
```

---

## Text Override System (Live Preview)

The Copy tab enables live text editing without modifying source files.

**Flow:**

1. Copy tab sends `SET_TEXT_OVERRIDES` postMessage with a map of `{ [inspectorId]: { [propName]: value } }`
2. `preview-bootstrap.js` contains a `TextOverrideApplier` component that applies overrides via direct DOM mutation
3. A `MutationObserver` re-applies overrides after every React re-render (React overwrites direct DOM changes)
4. Original values are tracked in an `_originals` map for clean revert

**Supported prop types:** `children` (text nodes), `placeholder`, `aria-label`, `label` (Chip labels), `helperText`, `title`

---

## Conflict Detection

When a developer changes source text that a designer has already edited:

1. `GET /api/preview/[id]/copy` compares `sourceValueAtEdit` in the overlay with the current source value
2. If they differ → entry is flagged as a conflict
3. UI shows resolution options: "Accept designer's" (use new source) or "Keep mine" (keep overlay value)

---

## Theme System

- MUI v6 with `cssVariables: true` — mode switching changes CSS variables only, no component re-renders
- `colorSchemeSelector: 'data-mui-color-scheme'` matches `InitColorSchemeScript` attribute (prevents flash)
- Three modes: light, dark, system (auto-detects OS preference)
- Theme is synced to iframe via `SET_THEME` postMessage
- AppBar uses `action.hover` background for subtle contrast

---

## Key Design Decisions

1. **Iframe isolation** — prototypes can't break the app shell; CSS/JS fully sandboxed
2. **CDN import maps** — MUI/React loaded from esm.sh, ensuring single React instance and avoiding bundling heavy dependencies
3. **Babel AST for inspection** — component tree and text entries extracted at build time, not runtime; no prototype code modification needed
4. **DOM mutation for text overrides** — avoids re-bundling on every keystroke; MutationObserver handles React re-renders
5. **SSE for hot reload** — lightweight, unidirectional; chokidar watches filesystem, EventSource in browser
6. **Zustand over Context** — minimal boilerplate, no provider nesting, works outside React tree
7. **No authentication** — local development tool; share tokens provide lightweight public access
8. **Prototype isolation rule** — CLAUDE.md enforces that AI assistants only modify files within a single prototype directory

---

## Development

```bash
npm run dev          # Start Next.js dev server
```

Prototypes live in `prototypes/`. Create a new one from the gallery UI or manually add a directory with `metadata.json` + `index.jsx`.

Environment variables:

| Variable | Default | Purpose |
|----------|---------|---------|
| `PROTOTYPES_DIR` | `./prototypes` | Root directory for prototype files |
