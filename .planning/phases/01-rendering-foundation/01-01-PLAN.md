---
phase: 01-rendering-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - package.json
  - src/lib/bundler.ts
  - src/lib/theme.ts
  - src/app/api/preview/[id]/bundle/route.ts
  - src/app/preview/[id]/page.tsx
  - public/preview-bootstrap.js
  - prototypes/sample/index.jsx
  - prototypes/sample/metadata.json
autonomous: true
requirements:
  - REND-01
  - REND-02
  - THME-01

must_haves:
  truths:
    - "A JSX file in /prototypes/sample/ is transpiled by esbuild and served as a JS bundle via GET /api/preview/sample/bundle"
    - "Opening /preview/sample in a browser renders the MUI prototype with correct styling (Emotion cache in iframe head)"
    - "A syntax error in the prototype JSX returns a 422 JSON error from the bundle API, not a 500 crash"
    - "A runtime render error in the prototype shows a readable error message with a Retry button inside the iframe"
    - "MUI ThemeProvider with colorSchemes (light + dark) lives inside the iframe document, not the parent shell"
  artifacts:
    - path: "src/lib/bundler.ts"
      provides: "esbuild build API wrapper with stdin, external React/MUI, ESM output"
      exports: ["bundlePrototype"]
    - path: "src/app/api/preview/[id]/bundle/route.ts"
      provides: "Next.js Route Handler serving transpiled JS bundle"
      exports: ["GET"]
    - path: "src/app/preview/[id]/page.tsx"
      provides: "Standalone HTML page with import map for React/MUI via esm.sh"
    - path: "public/preview-bootstrap.js"
      provides: "React root bootstrap with ThemeProvider + Emotion CacheProvider + ErrorBoundary"
    - path: "src/lib/theme.ts"
      provides: "createTheme config with cssVariables and colorSchemes"
      exports: ["theme"]
    - path: "prototypes/sample/index.jsx"
      provides: "Sample prototype for testing the pipeline"
  key_links:
    - from: "src/app/api/preview/[id]/bundle/route.ts"
      to: "src/lib/bundler.ts"
      via: "import bundlePrototype"
      pattern: "import.*bundlePrototype.*bundler"
    - from: "public/preview-bootstrap.js"
      to: "/api/preview/[id]/bundle"
      via: "dynamic import of bundle URL"
      pattern: "import\\(.*bundleUrl"
    - from: "public/preview-bootstrap.js"
      to: "src/lib/theme.ts concept"
      via: "createTheme with colorSchemes inside iframe"
      pattern: "createTheme.*colorSchemes"
---

<objective>
Build the end-to-end rendering pipeline: esbuild transpiles Claude Code-generated JSX on the server, a Next.js API route serves the bundle, and a dedicated preview page renders it inside a standalone HTML document with MUI ThemeProvider, Emotion CacheProvider, and ErrorBoundary — all inside the iframe document.

Purpose: This is the foundational pipeline that every subsequent feature depends on. Without live JSX rendering in a sandboxed iframe with correct MUI styling, nothing else works.

Output: A working `/preview/[id]` page that renders any valid JSX prototype from the `/prototypes/` directory with full MUI styling, error handling for both build-time and runtime errors, and ThemeProvider architecture ready for dark/light mode switching.
</objective>

<execution_context>
@/Users/gyorgybokros/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gyorgybokros/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-rendering-foundation/01-RESEARCH.md
@.planning/phases/01-rendering-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, configure Next.js, and create the esbuild bundler + API route</name>
  <files>
    package.json
    next.config.ts
    src/lib/bundler.ts
    src/app/api/preview/[id]/bundle/route.ts
  </files>
  <action>
**Install dependencies:**
```bash
npm install esbuild @emotion/cache react-error-boundary chokidar nanoid
```
Note: `@mui/material`, `@emotion/react`, `@emotion/styled`, `react`, `react-dom` should already be in the project. If not, install them too:
```bash
npm install @mui/material @emotion/react @emotion/styled react react-dom react-dom
```

**Configure next.config.ts:**
Add `serverExternalPackages: ['esbuild']` to the Next.js config. This is REQUIRED — without it, webpack bundles esbuild's binary and breaks its path resolution. Do NOT enable Turbopack (no `--turbopack` flag in dev script) — there is an open Next.js bug (#83630) where esbuild fails with Turbopack even with serverExternalPackages.

**Create `src/lib/bundler.ts`:**
- Export `bundlePrototype(filePath: string): Promise<string>`
- Use `esbuild.build()` with `stdin` (NOT `transform()` — transform does not support `external`)
- Read file contents with `fs/promises` readFile
- stdin config: `{ contents, loader: 'jsx', resolveDir: path.dirname(filePath) }`
- `bundle: true`, `write: false`, `format: 'esm'`, `jsx: 'automatic'`, `jsxImportSource: 'react'`
- `external: ['react', 'react-dom', 'react/jsx-runtime', '@mui/*', '@emotion/*']`
- Return `result.outputFiles[0].text`
- Handle the case where the file has no default export: scan for `export default` in the source. If missing, find the last top-level function/const component declaration and append `export default ComponentName;`. Log a warning to console.

**Create `src/app/api/preview/[id]/bundle/route.ts`:**
- Export async `GET` handler
- Read prototype ID from route params
- Resolve file path: `path.join(process.env.PROTOTYPES_DIR ?? './prototypes', params.id, 'index.jsx')`
- Call `bundlePrototype(filePath)`
- On success: return `new NextResponse(bundle, { headers: { 'Content-Type': 'text/javascript' } })`
- On error: return `NextResponse.json({ error: message }, { status: 422 })` — this covers esbuild compile errors (syntax errors in the JSX)
- Add `export const dynamic = 'force-dynamic'` to prevent caching
  </action>
  <verify>
    <automated>npx tsc --noEmit src/lib/bundler.ts src/app/api/preview/*/bundle/route.ts 2>&1 | head -20</automated>
  </verify>
  <done>
- `npm install` succeeds with esbuild, @emotion/cache, react-error-boundary, chokidar, nanoid in package.json
- `next.config.ts` has `serverExternalPackages: ['esbuild']`
- `bundlePrototype()` compiles a valid JSX file to ESM with React/MUI externalized
- GET `/api/preview/sample/bundle` returns `text/javascript` for a valid prototype
- GET `/api/preview/nonexistent/bundle` returns 422 JSON error
  </done>
</task>

<task type="auto">
  <name>Task 2: Create the preview page with import map and bootstrap script (ThemeProvider + Emotion + ErrorBoundary)</name>
  <files>
    src/app/preview/[id]/page.tsx
    public/preview-bootstrap.js
    src/lib/theme.ts
  </files>
  <action>
**Create `src/lib/theme.ts`:**
- Export a `createAppTheme()` function that returns `createTheme({ cssVariables: true, colorSchemes: { light: true, dark: true } })`
- This is the shared theme config used both by the app shell (Plan 02) and referenced conceptually by the iframe bootstrap
- The `cssVariables: true` enables CSS variable mode — mode switching does NOT cause component re-renders, only CSS variable values change

**Create `src/app/preview/[id]/page.tsx`:**
- This page renders INSIDE the iframe — it IS the iframe's document
- It must be a server component that returns a full HTML structure
- Include a `<script type="importmap">` with these mappings (use `dangerouslySetInnerHTML`):
  ```json
  {
    "imports": {
      "react": "https://esm.sh/react@19",
      "react/jsx-runtime": "https://esm.sh/react@19/jsx-runtime",
      "react-dom": "https://esm.sh/react-dom@19",
      "react-dom/client": "https://esm.sh/react-dom@19/client",
      "@mui/material": "https://esm.sh/@mui/material@6?external=react,react-dom,@emotion/react,@emotion/styled",
      "@mui/material/styles": "https://esm.sh/@mui/material@6/styles?external=react,react-dom,@emotion/react,@emotion/styled",
      "@emotion/react": "https://esm.sh/@emotion/react@11?external=react",
      "@emotion/styled": "https://esm.sh/@emotion/styled@11?external=react,@emotion/react",
      "@emotion/cache": "https://esm.sh/@emotion/cache@11",
      "react-error-boundary": "https://esm.sh/react-error-boundary@5?external=react"
    }
  }
  ```
- The `?external=react,react-dom` parameter tells esm.sh to leave those imports as bare specifiers resolved by the import map — this ensures a single React instance (prevents hook errors from Pitfall 4)
- Include `<div id="root"></div>` for the React mount point
- Include `<script type="module" src="/preview-bootstrap.js" data-bundle-url={bundleUrl}></script>` where `bundleUrl = /api/preview/${params.id}/bundle`
- Add basic HTML with `<meta charset="utf-8">`, `<meta name="viewport" content="width=device-width, initial-scale=1">`
- Use `metadata` export for the page title: `Preview: ${params.id}`

IMPORTANT: This page should NOT use Next.js layout or any app shell styling. It should be a minimal HTML document. Consider using a custom `layout.tsx` in the `preview/[id]` directory that returns just `{children}` with no `<html>` wrapper, or use a route handler that returns raw HTML instead of a React page. The goal: the iframe loads a standalone HTML document with ONLY the import map, root div, and bootstrap script.

**Create `public/preview-bootstrap.js`:**
This script runs inside the iframe document. It:
1. Gets the bundle URL from `document.currentScript.dataset.bundleUrl`
2. Creates an Emotion cache: `createCache({ key: 'mui', container: document.head })` — this is CRITICAL, without it MUI styles inject into the parent document's head and don't render in the iframe (Pitfall 3)
3. Creates the MUI theme: `createTheme({ cssVariables: true, colorSchemes: { light: true, dark: true } })`
4. Creates a React root on `document.getElementById('root')`
5. Dynamically imports the bundle URL
6. Gets `module.default` as the prototype component
7. Renders the component wrapped in: `CacheProvider > ThemeProvider > CssBaseline > ErrorBoundary > Component`
8. The ErrorBoundary uses a fallback component that shows: error message in monospace, a Retry button, and posts `{ type: 'RENDER_ERROR', message }` to `window.parent` via postMessage
9. If the dynamic import itself fails (bundle fetch error, module parse error), catch the error and render an error display directly (not via ErrorBoundary — this is a pre-mount error)
10. Listen for `SET_THEME` postMessage events: `window.addEventListener('message', handler)` where handler calls MUI's `setMode()` from `useColorScheme()`. NOTE: since the bootstrap is vanilla JS, not a React component, you need to store a ref to the setMode function. Create a small React component (`ThemeListener`) that uses `useColorScheme()` and registers the postMessage listener internally.
11. Listen for `RELOAD` postMessage events: re-import the bundle URL (append `?t=Date.now()` cache buster) and re-render

Use `createElement` calls (not JSX) since this is a plain .js file that runs in the browser without transpilation.
  </action>
  <verify>
    <automated>curl -s http://localhost:3000/preview/sample 2>/dev/null | grep -c "importmap" || echo "Start dev server first: npm run dev"</automated>
  </verify>
  <done>
- `/preview/sample` serves a standalone HTML document (not wrapped in Next.js app shell)
- The HTML contains an import map resolving react, react-dom, @mui/material, @emotion/* to esm.sh CDN URLs
- The bootstrap script creates a React root with ThemeProvider + CacheProvider + ErrorBoundary
- MUI styles render correctly inside the iframe (Emotion cache targets iframe document.head)
- A prototype with a runtime error shows a readable error message + Retry button
- The bootstrap listens for SET_THEME and RELOAD postMessage events
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sample prototype and empty state handling</name>
  <files>
    prototypes/sample/index.jsx
    prototypes/sample/metadata.json
  </files>
  <action>
**Create `prototypes/sample/index.jsx`:**
A representative Claude Code-generated MUI prototype that exercises multiple MUI components. Must have `export default` function component. Example:

```jsx
import { Box, Paper, Typography, Button, Stack, TextField, Card, CardContent, CardActions, Chip } from '@mui/material';

export default function SamplePrototype() {
  return (
    <Box sx={{ p: 3, maxWidth: 600, mx: 'auto' }}>
      <Typography variant="h4" gutterBottom>
        Sample Prototype
      </Typography>
      <Typography variant="body1" color="text.secondary" sx={{ mb: 3 }}>
        This is a sample Claude Code-generated prototype to verify the rendering pipeline.
      </Typography>
      <Stack spacing={2}>
        <TextField label="Email" variant="outlined" fullWidth />
        <TextField label="Password" type="password" variant="outlined" fullWidth />
        <Card variant="outlined">
          <CardContent>
            <Typography variant="h6">Card Title</Typography>
            <Typography variant="body2" color="text.secondary">
              Card content with some descriptive text.
            </Typography>
            <Stack direction="row" spacing={1} sx={{ mt: 1 }}>
              <Chip label="Tag 1" size="small" />
              <Chip label="Tag 2" size="small" color="primary" />
            </Stack>
          </CardContent>
          <CardActions>
            <Button size="small">Learn More</Button>
          </CardActions>
        </Card>
        <Stack direction="row" spacing={2}>
          <Button variant="contained">Submit</Button>
          <Button variant="outlined">Cancel</Button>
        </Stack>
      </Stack>
    </Box>
  );
}
```

**Create `prototypes/sample/metadata.json`:**
```json
{
  "name": "Sample Prototype",
  "createdAt": "2026-02-27T00:00:00Z"
}
```

This establishes the convention: each prototype is a folder under `/prototypes/` containing `index.jsx` (required) and `metadata.json` (optional). The folder name is the prototype ID used in URLs.

**Add `.gitkeep` or a README note in `/prototypes/` explaining the convention** for Claude Code users who will generate prototypes into this directory.
  </action>
  <verify>
    <automated>test -f prototypes/sample/index.jsx && test -f prototypes/sample/metadata.json && echo "OK" || echo "MISSING"</automated>
  </verify>
  <done>
- `prototypes/sample/index.jsx` exists with a default-exported MUI component using Box, Paper, Typography, Button, Stack, TextField, Card, Chip
- `prototypes/sample/metadata.json` exists with name and createdAt
- The prototype renders correctly when accessed via `/preview/sample` (verified in Task 2)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors (Next.js can compile all routes)
2. `npm run dev` starts the dev server on localhost:3000
3. `curl http://localhost:3000/api/preview/sample/bundle` returns JavaScript content (not HTML, not error)
4. `curl http://localhost:3000/preview/sample` returns HTML with an import map containing esm.sh URLs
5. Opening `http://localhost:3000/preview/sample` in Chrome renders the sample MUI prototype with correct styling
6. Introducing a syntax error in `prototypes/sample/index.jsx` and refreshing `/api/preview/sample/bundle` returns 422 JSON
</verification>

<success_criteria>
- The esbuild bundler transpiles JSX to ESM with React/MUI externalized via import map
- The preview page is a standalone HTML document (not wrapped in Next.js app shell)
- MUI styles render correctly inside the preview page (Emotion cache targets the page's document.head)
- Build-time errors (syntax) return 422 JSON from the API
- Runtime errors show a readable message with Retry button
- ThemeProvider with colorSchemes lives inside the preview document, ready for dark/light switching via postMessage
</success_criteria>

<output>
After completion, create `.planning/phases/01-rendering-foundation/01-01-SUMMARY.md`
</output>
